version: '3.8'

services:
  # --- ModernFM All-in-One 服务 (后端 + 前端托管) ---
  modern-fm:
    image: ryantj/modern-fm:latest
    container_name: modern-fm-app
    restart: always
    environment:
      - DB_URL=postgres://modernfm_user:secure_pass_123@db:5432/modernfm
      - REDIS_URL=redis:6379
      - ROOT_DIR=/data
      - TZ=Asia/Shanghai
    volumes:
      - /mnt/user:/data             # 映射您的真实数据目录
      - /mnt/user/appdata/modern-fm/uploads_temp:/app/uploads_temp
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "38866:38866"
    networks:
      - modern-fm-net

  # --- 数据库 ---
  db:
    image: postgres:15-alpine
    container_name: modern-fm-db
    restart: always
    environment:
      POSTGRES_USER: modernfm_user
      POSTGRES_PASSWORD: secure_pass_123
      POSTGRES_DB: modernfm
    volumes:
      - /mnt/user/appdata/modern-fm/db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U modernfm_user -d modernfm"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - modern-fm-net

  # --- 缓存 ---
  redis:
    image: redis:7-alpine
    container_name: modern-fm-redis
    restart: always
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - /mnt/user/appdata/modern-fm/redis:/data  # Redis指定存储路径
    networks:
      - modern-fm-net

networks:
  modern-fm-net:
    driver: bridge
